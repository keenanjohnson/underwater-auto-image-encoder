name: Build GUI Application

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write  # Required for creating/updating releases

jobs:
  build:
    strategy:
      fail-fast: false  # Don't cancel other jobs if one fails
      matrix:
        # Windows build temporarily disabled - will be fixed in separate PR
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
            binary_name: UnderwaterEnhancer
            gpr_binary: binaries/linux/gpr_tools
          - os: windows-latest
            platform: windows
            binary_name: UnderwaterEnhancer.exe
            gpr_binary: binaries/win32/gpr_tools.exe
          - os: macos-latest
            platform: macos
            binary_name: UnderwaterEnhancer.app
            gpr_binary: binaries/darwin/gpr_tools

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Get pip cache dir
      id: pip-cache
      shell: bash
      run: |
        echo "dir=$(pip cache dir)" >> $GITHUB_OUTPUT

    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ${{ steps.pip-cache.outputs.dir }}
        key: ${{ runner.os }}-pip-universal-${{ hashFiles('**/requirements*.txt', 'gui/features.py') }}
        restore-keys: |
          ${{ runner.os }}-pip-universal-
          ${{ runner.os }}-pip-

    - name: Free disk space (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        echo "Disk space before cleanup:"
        df -h

        # Remove large unused packages
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"

        # Clean apt cache
        sudo apt-get clean

        echo "Disk space after cleanup:"
        df -h

    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          python3-tk \
          libgl1 \
          libglib2.0-0 \
          libsm6 \
          libxext6 \
          libxrender1 \
          libgomp1 \
          libgtk-3-0 \
          libgstreamer-gl1.0-0 \
          libgstreamer-plugins-base1.0-0 \
          libxcb-xinerama0 \
          libxkbcommon-x11-0

    - name: Install system dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        # Check if cmake is already available
        if ! command -v cmake &> /dev/null; then
          echo "Installing cmake..."
          brew install cmake
        else
          echo "cmake is already installed: $(cmake --version | head -1)"
        fi

    - name: Setup MSVC (Windows)
      if: matrix.os == 'windows-latest'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install system dependencies (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        # CMake is usually pre-installed, but install if missing
        if (!(Get-Command cmake -ErrorAction SilentlyContinue)) {
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
        } else {
          Write-Host "CMake already installed: $(cmake --version)"
        }
        # Install Ninja for faster builds
        choco install ninja -y

    - name: Set UTF-8 encoding for Windows
      if: matrix.os == 'windows-latest'
      run: |
        echo "PYTHONUTF8=1" >> $env:GITHUB_ENV
        echo "PYTHONIOENCODING=utf-8" >> $env:GITHUB_ENV
      shell: pwsh

    - name: Verify build tools
      run: |
        echo "Checking build tools..."
        cmake --version || echo "cmake not found"
        python --version
        pip --version

    - name: Check GPR support feature flag
      id: check-gpr
      run: |
        GPR_ENABLED=$(python -c "from gui.features import GPR_SUPPORT_ENABLED; print('true' if GPR_SUPPORT_ENABLED else 'false')")
        echo "gpr_enabled=$GPR_ENABLED" >> $GITHUB_OUTPUT
        echo "GPR Support Enabled: $GPR_ENABLED"
      shell: bash

    - name: Install Python dependencies (Universal GPU/CPU Build)
      run: |
        python -m pip install --upgrade pip

        # Install PyTorch based on platform
        if [ "${{ matrix.os }}" == "macos-latest" ]; then
          echo "Installing PyTorch for macOS (includes MPS support)..."
          pip install torch torchvision
        elif [ "${{ matrix.os }}" == "windows-latest" ]; then
          echo "Installing PyTorch with CUDA support for Windows..."
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cu121
        else
          echo "Installing PyTorch with CUDA support for Linux..."
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cu121
        fi

        # Install other dependencies, excluding rawpy if GPR support is disabled
        if [ "${{ steps.check-gpr.outputs.gpr_enabled }}" == "true" ]; then
          echo "Installing all dependencies (GPR support enabled)..."
          pip install -r requirements_gui.txt
        else
          echo "Installing dependencies without rawpy (GPR support disabled)..."
          grep -v "^rawpy" requirements_gui.txt > requirements_gui_no_gpr.txt
          pip install -r requirements_gui_no_gpr.txt
          rm requirements_gui_no_gpr.txt
        fi

        # Verify PyTorch installation
        python -c "import torch; print(f'PyTorch {torch.__version__} installed')"
        python -c "import torch; print(f'CUDA available: {torch.cuda.is_available()}')"
        python -c "import torch; print(f'MPS available: {torch.backends.mps.is_available() if hasattr(torch.backends, \"mps\") else False}')"

        # Verify rawpy exclusion when GPR is disabled
        if [ "${{ steps.check-gpr.outputs.gpr_enabled }}" == "false" ]; then
          if python -c "import rawpy" 2>/dev/null; then
            echo "ERROR: rawpy is installed but GPR support is disabled!"
            pip uninstall -y rawpy
            echo "Uninstalled rawpy"
          else
            echo "OK: rawpy is not installed (as expected)"
          fi
        fi
      shell: bash

    - name: Compile GPR tools (Linux/macOS)
      if: matrix.os != 'windows-latest' && steps.check-gpr.outputs.gpr_enabled == 'true'
      run: |
        echo "Compiling GPR tools from source..."
        chmod +x build_scripts/compile_gpr_tools.sh
        ./build_scripts/compile_gpr_tools.sh
        if [ $? -ne 0 ]; then
          echo "FATAL: GPR tools compilation failed"
          exit 1
        fi

        # Verify binary exists and is valid
        if [ ! -f "${{ matrix.gpr_binary }}" ]; then
          echo "FATAL: GPR tools binary not found at expected location: ${{ matrix.gpr_binary }}"
          exit 1
        fi

        # Check file size to ensure it's not a placeholder
        SIZE=$(stat -f%z "${{ matrix.gpr_binary }}" 2>/dev/null || stat -c%s "${{ matrix.gpr_binary }}")
        if [ "$SIZE" -lt 10000 ]; then
          echo "FATAL: GPR tools binary is too small ($SIZE bytes) - likely corrupted or placeholder"
          exit 1
        fi

        echo "SUCCESS: GPR tools binary found and validated"
        ls -la "${{ matrix.gpr_binary }}"

    - name: Compile GPR tools (Windows)
      if: matrix.os == 'windows-latest' && steps.check-gpr.outputs.gpr_enabled == 'true'
      shell: cmd
      run: |
        echo Compiling GPR tools from source...
        build_scripts\compile_gpr_tools.bat
        if %ERRORLEVEL% neq 0 (
          echo FATAL: GPR tools compilation failed with exit code %ERRORLEVEL%
          exit /b 1
        )

        REM Verify the binary exists and is valid
        if not exist "${{ matrix.gpr_binary }}" (
          echo FATAL: GPR tools binary not found at expected location: ${{ matrix.gpr_binary }}
          exit /b 1
        )

        REM Check file size to ensure it's not a placeholder
        for %%I in ("${{ matrix.gpr_binary }}") do set SIZE=%%~zI
        if %SIZE% LSS 10000 (
          echo FATAL: GPR tools binary is too small (%SIZE% bytes) - likely corrupted or placeholder
          exit /b 1
        )

        echo SUCCESS: GPR tools binary found and validated
        dir "${{ matrix.gpr_binary }}"

    - name: Skip GPR tools (disabled)
      if: steps.check-gpr.outputs.gpr_enabled == 'false'
      run: echo "GPR support is disabled - skipping GPR tools compilation"
      shell: bash

    - name: Create placeholder icons
      run: |
        python -c "
        from pathlib import Path
        import os
        
        # Create assets directory
        Path('assets').mkdir(exist_ok=True)
        
        # Create placeholder icon.png
        try:
            from PIL import Image, ImageDraw
            size = 256
            img = Image.new('RGBA', (size, size), (0, 0, 0, 0))
            draw = ImageDraw.Draw(img)
            draw.ellipse([10, 10, size-10, size-10], fill=(30, 144, 255))
            img.save('assets/icon.png')
            print('Created icon.png')
            
            # Create ICO for Windows
            if '${{ matrix.os }}' == 'windows-latest':
                img.save('assets/icon.ico', format='ICO', sizes=[(256, 256)])
                print('Created icon.ico')
        except ImportError:
            print('PIL not available, skipping icon creation')
        "

    - name: Check source files before build
      run: |
        echo "Checking src directory structure:"
        python -c "import os; print('\n'.join(os.listdir('src')))"
        echo "Checking src/models:"
        python -c "import os; print('\n'.join(os.listdir('src/models')) if os.path.exists('src/models') else 'src/models does not exist!')"
        echo "Python files in src:"
        python -c "import os; [print(os.path.join(r, f)) for r, d, files in os.walk('src') for f in sorted(files) if f.endswith('.py')]"

    - name: Verify GPR binary exists before PyInstaller
      if: steps.check-gpr.outputs.gpr_enabled == 'true'
      run: |
        echo "Checking for GPR binary at: ${{ matrix.gpr_binary }}"
        if [ -f "${{ matrix.gpr_binary }}" ]; then
          echo "✓ Binary found"
          ls -lh "${{ matrix.gpr_binary }}"
        else
          echo "✗ Binary NOT found"
          echo "Contents of binaries directory:"
          ls -la binaries/ || echo "binaries/ directory does not exist"
          echo "Current working directory:"
          pwd
          echo "Directory contents:"
          ls -la
          exit 1
        fi
      shell: bash

    - name: Build with PyInstaller
      run: |
        echo "Building universal GPU/CPU executable..."
        pyinstaller gui/pyinstaller.spec --clean --noconfirm
        echo "Built universal GPU/CPU executable"
      shell: bash
    
    - name: Fix macOS App Permissions
      if: matrix.os == 'macos-latest'
      run: |
        # Make the app executable and remove extended attributes
        chmod +x dist/UnderwaterEnhancer.app/Contents/MacOS/UnderwaterEnhancer
        # Remove quarantine attributes that might be added
        xattr -cr dist/UnderwaterEnhancer.app || true
        # Ad-hoc sign the app (allows it to run on the same machine and others with reduced security)
        codesign --force --deep --sign - dist/UnderwaterEnhancer.app
        echo "App has been ad-hoc signed"

    - name: List dist contents
      run: |
        python -c "
        import os
        for root, dirs, files in os.walk('dist'):
            level = root.replace('dist', '').count(os.sep)
            indent = ' ' * 2 * level
            print(f'{indent}{os.path.basename(root)}/')
            subindent = ' ' * 2 * (level + 1)
            for file in files[:10]:  # Limit to first 10 files
                print(f'{subindent}{file}')
        "

    - name: Check executable size
      run: |
        python -c "
        import os
        import platform

        if platform.system() == 'Darwin':
            # macOS app bundle
            app_path = 'dist/UnderwaterEnhancer.app'
            total_size = sum(
                os.path.getsize(os.path.join(dirpath, filename))
                for dirpath, dirnames, filenames in os.walk(app_path)
                for filename in filenames
            )
        elif platform.system() == 'Windows':
            total_size = os.path.getsize('dist/UnderwaterEnhancer.exe')
        else:
            total_size = os.path.getsize('dist/UnderwaterEnhancer')

        size_mb = total_size / (1024 * 1024)
        size_gb = total_size / (1024 * 1024 * 1024)

        if size_gb >= 1:
            print(f'Executable size: {size_gb:.2f} GB ({total_size:,} bytes)')
        else:
            print(f'Executable size: {size_mb:.2f} MB ({total_size:,} bytes)')

        # Warn if size seems wrong for universal build
        if platform.system() != 'Darwin' and size_mb < 1000:
            print('WARNING: Universal build seems too small! Expected >1GB for GPU support.')
        "

    - name: Test executable exists
      run: |
        python -c "
        import os
        import sys
        import platform
        
        # Use ASCII characters on Windows to avoid encoding issues
        check = '[OK]' if platform.system() == 'Windows' else '✓'
        cross = '[X]' if platform.system() == 'Windows' else '✗'
        
        expected_path = 'dist/${{ matrix.binary_name }}'
        if os.path.exists(expected_path):
            print(f'{check} Found {expected_path}')
            file_size = os.path.getsize(expected_path) if os.path.isfile(expected_path) else 0
            if file_size > 0:
                print(f'  Size: {file_size / 1024 / 1024:.2f} MB')
        else:
            print(f'{cross} Not found: {expected_path}')
            sys.exit(1)
        "

    - name: Smoke test - Test binary startup and GPU detection
      run: |
        echo "Testing binary startup and GPU detection..."

        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          dist/UnderwaterEnhancer.exe --smoke-test
        elif [ "${{ matrix.os }}" == "macos-latest" ]; then
          # Check app bundle structure first
          echo "Checking app bundle structure..."
          test -f dist/UnderwaterEnhancer.app/Contents/MacOS/UnderwaterEnhancer || (echo "Binary not found!" && exit 1)
          test -f dist/UnderwaterEnhancer.app/Contents/Info.plist || (echo "Info.plist not found!" && exit 1)
          echo "  [OK] App bundle structure valid"

          # Test binary execution
          echo "Testing binary execution..."
          dist/UnderwaterEnhancer.app/Contents/MacOS/UnderwaterEnhancer --smoke-test
        else
          dist/UnderwaterEnhancer --smoke-test
        fi
      shell: bash

    - name: Create release archive
      run: |
        # All builds are universal (GPU/CPU support)
        if [ "${{ matrix.os }}" == "ubuntu-latest" ]; then
          cd dist
          tar -czf "../UnderwaterEnhancer-${{ matrix.platform }}-universal.tar.gz" *
          cd ..
        elif [ "${{ matrix.os }}" == "macos-latest" ]; then
          cd dist
          # Create a DMG for better macOS distribution (optional, falls back to zip)
          if command -v hdiutil &> /dev/null; then
            hdiutil create -volname "UnderwaterEnhancer" -srcfolder "UnderwaterEnhancer.app" -ov -format UDZO "../UnderwaterEnhancer-${{ matrix.platform }}-universal.dmg" || \
            zip -r "../UnderwaterEnhancer-${{ matrix.platform }}-universal.zip" "UnderwaterEnhancer.app"
          else
            zip -r "../UnderwaterEnhancer-${{ matrix.platform }}-universal.zip" "UnderwaterEnhancer.app"
          fi
          cd ..
        else
          # Windows
          cp "dist/UnderwaterEnhancer.exe" "UnderwaterEnhancer-${{ matrix.platform }}-universal.exe"
        fi
      shell: bash

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: UnderwaterEnhancer-${{ matrix.platform }}-universal
        path: |
          UnderwaterEnhancer-${{ matrix.platform }}-universal.*
        retention-days: 7

    - name: Upload to Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          UnderwaterEnhancer-${{ matrix.platform }}-universal.*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}