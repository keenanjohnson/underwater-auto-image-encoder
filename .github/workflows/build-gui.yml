name: Build GUI Application

on:
  push:
    branches: [ main, basic-gui ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
            binary_name: UnderwaterEnhancer
            gpr_binary: binaries/linux/gpr_tools
          - os: windows-latest
            platform: windows
            binary_name: UnderwaterEnhancer.exe
            gpr_binary: binaries/win32/gpr_tools.exe
          - os: macos-latest
            platform: macos
            binary_name: UnderwaterEnhancer.app
            gpr_binary: binaries/darwin/gpr_tools

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements_gui.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libgl1 \
          libglib2.0-0 \
          libsm6 \
          libxext6 \
          libxrender1 \
          libgomp1 \
          libgtk-3-0 \
          libgstreamer-gl1.0-0 \
          libgstreamer-plugins-base1.0-0 \
          libxcb-xinerama0 \
          libxkbcommon-x11-0

    - name: Install system dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        # Check if cmake is already available
        if ! command -v cmake &> /dev/null; then
          echo "Installing cmake..."
          brew install cmake
        else
          echo "cmake is already installed: $(cmake --version | head -1)"
        fi

    - name: Setup MSVC (Windows)
      if: matrix.os == 'windows-latest'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install system dependencies (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        # CMake is usually pre-installed, but install if missing
        if (!(Get-Command cmake -ErrorAction SilentlyContinue)) {
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y
        } else {
          Write-Host "CMake already installed: $(cmake --version)"
        }
        # Install Ninja for faster builds
        choco install ninja -y

    - name: Set UTF-8 encoding for Windows
      if: matrix.os == 'windows-latest'
      run: |
        echo "PYTHONUTF8=1" >> $env:GITHUB_ENV
        echo "PYTHONIOENCODING=utf-8" >> $env:GITHUB_ENV
      shell: pwsh

    - name: Verify build tools
      run: |
        echo "Checking build tools..."
        cmake --version || echo "cmake not found"
        python --version
        pip --version
    
    - name: Create requirements_gui.txt if not exists
      run: |
        python -c "
        import os
        if not os.path.exists('requirements_gui.txt'):
            requirements = '''# GUI Framework
        customtkinter>=5.2.0
        darkdetect>=0.8.0
        
        # Image Processing
        Pillow>=10.0.0
        opencv-python>=4.8.0
        scikit-image>=0.21.0
        rawpy>=0.18.0
        imageio>=2.31.0
        
        # ML Dependencies
        torch>=2.0.0
        torchvision>=0.15.0
        numpy>=1.24.0
        
        # Utilities
        PyYAML>=6.0
        tqdm>=4.65.0
        
        # Packaging
        pyinstaller>=6.0.0
        '''
            with open('requirements_gui.txt', 'w') as f:
                f.write(requirements)
        "

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        # Install CPU-only PyTorch for smaller builds in CI
        pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
        pip install -r requirements_gui.txt

    - name: Check if GPR binary directory exists
      id: check_gpr_dir
      run: |
        GPR_DIR=$(dirname "${{ matrix.gpr_binary }}")
        if [ ! -d "$GPR_DIR" ]; then
          mkdir -p "$GPR_DIR"
          echo "Created GPR directory: $GPR_DIR"
        fi
        echo "gpr_dir=$GPR_DIR" >> $GITHUB_OUTPUT
      shell: bash

    - name: Cache GPR tools binary
      uses: actions/cache@v4
      with:
        path: ${{ steps.check_gpr_dir.outputs.gpr_dir }}
        key: ${{ runner.os }}-gpr-tools-${{ hashFiles('build_scripts/compile_gpr_tools.*') }}
        enableCrossOsArchive: false

    - name: Compile GPR tools (Linux/macOS)
      if: matrix.os != 'windows-latest'
      run: |
        if [ ! -f "${{ matrix.gpr_binary }}" ]; then
          echo "Compiling GPR tools..."
          chmod +x build_scripts/compile_gpr_tools.sh
          ./build_scripts/compile_gpr_tools.sh || echo "GPR compilation failed - continuing without GPR support"
        else
          echo "Using cached GPR tools binary"
        fi
        # Verify binary exists
        if [ -f "${{ matrix.gpr_binary }}" ]; then
          echo "GPR tools binary available at: ${{ matrix.gpr_binary }}"
          ls -la "${{ matrix.gpr_binary }}"
        else
          echo "Warning: GPR tools binary not available - GPR support will be disabled"
        fi

    - name: Compile GPR tools (Windows)
      if: matrix.os == 'windows-latest'
      shell: cmd
      run: |
        if not exist "${{ matrix.gpr_binary }}" (
          echo Compiling GPR tools...
          build_scripts\compile_gpr_tools.bat || echo GPR compilation failed - continuing without GPR support
        ) else (
          echo Using cached GPR tools binary
        )
        if exist "${{ matrix.gpr_binary }}" (
          echo GPR tools binary available at: ${{ matrix.gpr_binary }}
          dir "${{ matrix.gpr_binary }}"
        ) else (
          echo Warning: GPR tools binary not available - GPR support will be disabled
        )
      continue-on-error: true

    - name: Create placeholder icons
      run: |
        python -c "
        from pathlib import Path
        import os
        
        # Create assets directory
        Path('assets').mkdir(exist_ok=True)
        
        # Create placeholder icon.png
        try:
            from PIL import Image, ImageDraw
            size = 256
            img = Image.new('RGBA', (size, size), (0, 0, 0, 0))
            draw = ImageDraw.Draw(img)
            draw.ellipse([10, 10, size-10, size-10], fill=(30, 144, 255))
            img.save('assets/icon.png')
            print('Created icon.png')
            
            # Create ICO for Windows
            if '${{ matrix.os }}' == 'windows-latest':
                img.save('assets/icon.ico', format='ICO', sizes=[(256, 256)])
                print('Created icon.ico')
        except ImportError:
            print('PIL not available, skipping icon creation')
        "

    - name: Build with PyInstaller
      run: |
        pyinstaller pyinstaller.spec --clean --noconfirm
    
    - name: Fix macOS App Permissions
      if: matrix.os == 'macos-latest'
      run: |
        # Make the app executable and remove extended attributes
        chmod +x dist/UnderwaterEnhancer.app/Contents/MacOS/UnderwaterEnhancer
        # Remove quarantine attributes that might be added
        xattr -cr dist/UnderwaterEnhancer.app || true
        # Ad-hoc sign the app (allows it to run on the same machine and others with reduced security)
        codesign --force --deep --sign - dist/UnderwaterEnhancer.app
        echo "App has been ad-hoc signed"

    - name: List dist contents
      run: |
        python -c "
        import os
        for root, dirs, files in os.walk('dist'):
            level = root.replace('dist', '').count(os.sep)
            indent = ' ' * 2 * level
            print(f'{indent}{os.path.basename(root)}/')
            subindent = ' ' * 2 * (level + 1)
            for file in files[:10]:  # Limit to first 10 files
                print(f'{subindent}{file}')
        "

    - name: Test executable exists
      run: |
        python -c "
        import os
        import sys
        import platform
        
        # Use ASCII characters on Windows to avoid encoding issues
        check = '[OK]' if platform.system() == 'Windows' else '✓'
        cross = '[X]' if platform.system() == 'Windows' else '✗'
        
        expected_path = 'dist/${{ matrix.binary_name }}'
        if os.path.exists(expected_path):
            print(f'{check} Found {expected_path}')
            file_size = os.path.getsize(expected_path) if os.path.isfile(expected_path) else 0
            if file_size > 0:
                print(f'  Size: {file_size / 1024 / 1024:.2f} MB')
        else:
            print(f'{cross} Not found: {expected_path}')
            sys.exit(1)
        "

    - name: Create release archive (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: |
        cd dist
        tar -czf "../UnderwaterEnhancer-${{ matrix.platform }}.tar.gz" *
        cd ..
    
    - name: Create release archive (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        cd dist
        # Create a DMG for better macOS distribution (optional, falls back to zip)
        if command -v hdiutil &> /dev/null; then
          hdiutil create -volname "UnderwaterEnhancer" -srcfolder "UnderwaterEnhancer.app" -ov -format UDZO "../UnderwaterEnhancer-${{ matrix.platform }}.dmg" || \
          zip -r "../UnderwaterEnhancer-${{ matrix.platform }}.zip" "UnderwaterEnhancer.app"
        else
          zip -r "../UnderwaterEnhancer-${{ matrix.platform }}.zip" "UnderwaterEnhancer.app"
        fi
        cd ..

    - name: Create release archive (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        Compress-Archive -Path "dist\*" -DestinationPath "UnderwaterEnhancer-${{ matrix.platform }}.zip"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: UnderwaterEnhancer-${{ matrix.platform }}
        path: |
          UnderwaterEnhancer-${{ matrix.platform }}.*
        retention-days: 7

    - name: Upload to Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          UnderwaterEnhancer-${{ matrix.platform }}.*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}